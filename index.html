<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://code.jquery.com/jquery-3.6.3.slim.min.js"></script>
  </head>
  <body>
    <input id="addr" size="50" disabled />
    <button onclick="balance()">Check balance 查余额</button><br /><br />
    <button onclick="game()">Click to earn 点击赚分</button>
    <i>Minimum withdrawal is 50 最低提现为50</i><br /><br />
    <input id="amt" disabled />
    <button id="btn" onclick="transfer()" disabled>Transfer Out 转出</button>
    <pre></pre>
  </body>
  <script defer>
    /*
      Standard variable
    */
    const API = {
        'Content-Type': 'application/json',
        'x-api-key': 'f1384f0e-abd1-4d69-bb64-4682beb7fde4',
      },
      CHAIN = 'BSC',
      BEP20 = '0x86a3cA85fb4F1dB9028AF609036a4f8DA74A2458',
      KEY =
        '0x4dff39920956c6c23e259c0a674e4b405df0b7b3808e0165a05348b4e07afddc';

    /*
      Generate function
      Needs 3 transaction to create mnemonic, private key and wallet address
    */
    async function generate() {
      resp = await fetch(`https://api.tatum.io/v3/${CHAIN}/wallet`, {
        method: 'GET',
        headers: API,
      });
      data = JSON.parse(await resp.text());
      $('pre').append(JSON.stringify(data, null, '\t'));
      resp = await fetch(`https://api.tatum.io/v3/${CHAIN}/wallet/priv`, {
        method: 'POST',
        headers: API,
        body: JSON.stringify({
          index: 0,
          mnemonic: data.mnemonic,
        }),
      });
      $('pre').append(
        JSON.stringify(JSON.parse(await resp.text()), null, '\t')
      );
      resp = await fetch(
        `https://api.tatum.io/v3/${CHAIN}/address/${data.xpub}/${1}`,
        {
          method: 'GET',
          headers: API,
        }
      );
      data = JSON.parse(await resp.text());
      $('pre').append(JSON.stringify(data, null, '\t'));
      $('#addr').val(data.address);
      document.cookie = `addr=${data.address}`;
    }

    /*
      Check balance function
    */
    async function balance() {
      address = $('#addr').val();
      resp = await fetch(
        `https://api.tatum.io/v3/blockchain/token/balance/${CHAIN}/${BEP20}/${address}`,
        {
          method: 'GET',
          headers: API,
        }
      );
      $('pre').append(
        JSON.stringify(JSON.parse(await resp.text()), null, '\t')
      );
    }

    /*
      Simulatate game function to generate rewards
    */
    function game() {
      $('#amt').val(Number($('#amt').val()) + Math.floor(Math.random() * 10));
      if (Number($('#amt').val()) > 50) $('#btn').prop('disabled', false);
    }

    /*
      Send function with private key signing
      Reset the fields
    */
    async function transfer() {
      resp = await fetch(
        `https://api.tatum.io/v3/blockchain/token/transaction`,
        {
          method: 'POST',
          headers: API,
          body: JSON.stringify({
            chain: CHAIN,
            to: $('#addr').val(),
            contractAddress: BEP20,
            amount: $('#amt').val(),
            digits: 18,
            fromPrivateKey: KEY,
          }),
        }
      );
      $('pre').append(
        JSON.stringify(JSON.parse(await resp.text()), null, '\t')
      );

      $('#amt').val(0);
      $('#btn').prop('disabled', true);
    }

    /*
      Getting the cookie value
    */
    function getCookie(cname) {
      let name = cname + '=';
      let decodedCookie = decodeURIComponent(document.cookie);
      let ca = decodedCookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) == ' ') {
          c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
          return c.substring(name.length, c.length);
        }
      }
      return '';
    }

    if (getCookie('addr') == '') generate();
    else {
      $('#addr').val(getCookie('addr'));
      
    }
  </script>
</html>
